---
title: "Mining the Brundy and Thornton (2021) dataset"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r init}
require(tidyverse)
require(readr)
require(dplyr)

read_check_data <- function(file, code) {
  ## Read and check the data works out okay.
  debug <- FALSE
  dat <- read_csv(file)
  dat <- rename(dat, published="Published List Price", final="Final Net Price")

  diffs <- dat$final - dat$published
  error1 <- abs(diffs - dat$Difference)

  if (debug && !all( abs(error1)<=0.011))
    browser()

  alp <- (diffs / dat$published) * 100.0
  alp <- round(alp,1)
  error <- abs( alp - dat$ALP)
  if(debug && !all( error < 0.01))
    browser()
  
  dat %>% add_column(institution=code)
  
}
```
 
## Read in the data files

These were cleaned up (notes elsewhere) so that they could be read
into R.  One column seems to be incorrect, which needs fixing.

```{r read-data, echo=TRUE, results='hide',message=FALSE,warning=FALSE}
f <- read_check_data("data/FS_2020_Pricelist2.csv", "FS")
i <- read_check_data("data/ISU_2020_Pricelist2.csv", "ISU")
i$ALP <- i$ALP * -1 #bug -- see below
c <- read_check_data("data/UNC_2020_Pricelist2.csv", "UNC")
a <- read_check_data("data/IA_2020_Pricelist2.csv", "IA")
v <- read_check_data("data/WVU_2020_Pricelist2.csv", "WVU")
dat <- rbind(f, i, c, a, v)
```

Note - bug in the data: ALPs for ISU (Iowa) are the wrong sign.

```

## Plot the ALP for each institution
```{r plot}
ggplot(dat, aes(x=institution, y=ALP, color=institution)) +
  geom_jitter()
```

## Journals with  high ALP

e.g. find those greater than 30% than list price.  No surprises that
the outlier (384% ALP) is Cell.

```{r high-alp}
DT::datatable(filter(dat, ALP>=30))
```


##  Journals with low ALP

e.g. find those with at least 30% saving on list price.  
```{r low-alp}
DT::datatable(filter(dat, ALP<=-30))
```


## Raw database of files.

here you can search for individual journals, or sort them by ranking the
different columns.

e.g. by searching for "Trends in Genetics" you can see the variance in
price paid by 3 institutions.

```{r data}
DT::datatable(dat)
```

## Variance of prices

```{r counts}
f1 = f %>% select(Title, published,  FS=ALP)
i1 = i %>% select(Title, published, ISU=ALP)
c1 = c %>% select(Title, published, UNC=ALP)
a1 = a %>% select(Title, published,  IA=ALP)
v1 = v %>% select(Title, published, WVU=ALP)
dat1 <- full_join(f1, i1) %>% full_join(c1) %>% full_join(a1) %>% full_join(v1)
dat2 <- dat1 %>% select(FS, ISU, UNC, IA, WVU) %>% mutate(count=rowSums(!is.na(.)))
dat1$count <- dat2$count
```

Most journals are subscribed to by only one journal:

```{r table-of-counts}
table(dat1$count)
```

This table shows for each journal in the database the price paid by
each institution.  The column 'count' indicates the number of institutions
that subscribed to that journal, and varies between 1 and 5.  

```{r journal-variance}
DT::datatable(dat1)
```
